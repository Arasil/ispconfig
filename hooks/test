#!/bin/bash -xe

trap "echo Exited!; exit;" SIGINT SIGTERM

function build() {
  YML=$1
  ARG=$2
  CMD="docker-compose -f test/$YML build $ARG"
  if ! $CMD; then
    echo "Failed: \"$CMD\""
    exit 1
  fi

  DOWN="docker-compose -f test/$YML down -v"
  CMD="docker-compose -f test/$YML up --no-build --abort-on-container-exit sut"
  if ! $CMD; then
    echo "Failed: \"$CMD\""
    $DOWN &> /dev/null || true
    exit 1
  fi
  $DOWN &> /dev/null || true
}

function testNormal() {
  build docker-compose.bats.test.yml
  build docker-compose.bats.custom-ssl.test.yml
  build docker-compose.puppeteer.test.yml
  build docker-compose.puppeteer.no-phpmyadmin.test.yml
}

function testLiveDB() {
  if command -v gsed; then SED="gsed"; else SED="sed"; fi
  NO_MARIA="docker-compose.puppeteer.no-mariadb.test.yml"
  docker-compose -f "test/$NO_MARIA" up -d -V --force-recreate --remove-orphans mariadb
  IP_ADDR=$(docker network inspect ispconfig_default | grep "Gateway" | sed 's|^.*"Gateway": "\(.*\)"$|\1|')
  $SED -i'' "s/database: .*$/database: $IP_ADDR/" "test/$NO_MARIA"
  build "$NO_MARIA" --no-cache
  docker-compose -f "test/$NO_MARIA" down -v
}

testNormal
testLiveDB
