#!/bin/bash -e

if [ "$SOURCE_BRANCH" = "master" ]; then exit 0; fi

trap "echo Exited!; exit;" SIGINT SIGTERM

# shellcheck disable=SC1091
source "$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )/pre_build"
export CONTAINER="ispconfig-test"

function buildAndTest() {
  YML=$1
  UP="docker-compose -f test/$YML up --build --abort-on-container-exit --force-recreate --remove-orphans sut"
  DOWN="docker-compose -f test/$YML down -v"

  if ! $UP; then
    echo "Failed: \"$UP\""
    $DOWN || true
    exit 1
  fi
}

function cleanImage() {
    docker image rmi "$CONTAINER" 2> /dev/null || true
}

function testNormal() {
  for F in puppeteer puppeteer.no-phpmyadmin bats bats.custom-ssl bats.reconfigure; do
    buildAndTest "docker-compose.$F.test.yml"
  done
}

function testLiveDB() {
  function databaseUp() {
    docker-compose -f "test/$1" up -d -V --force-recreate --remove-orphans mariadb
  }
  function databaseDown() {
    docker stop mariadb || true
    docker rm mariadb || true
  }

  cleanImage
  databaseUp "$1"
  buildAndTest "$1"
  databaseDown "$1"
  cleanImage
}

testNormal

echo "$(tput bold)=> Tests succeeded! $(tput sgr0)"
